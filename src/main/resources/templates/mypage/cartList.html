<!DOCTYPE html>
<html lang="ko"
<!--      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"-->
      xmlns:th="http://www.thymeleaf.org"
<!--      layout:decorate="~{layout/layout.html}"-->
>
<!--<div layout:fragment="main">-->
    <div>
    <div class="cart-container">
        <!-- 상단: 전체 선택 및 강좌 수 -->
        <div class="cart-header">
            <label>
                <input type="checkbox" id="select-all">
                전체선택 <span id="course-count">(0/0)</span>
                <button id="delete-selected-btn" onclick="deleteBtns()">삭제</button>
            </label>
        </div>
        <!--        총가격+결제버튼부분-->
        <div class="cart-summary">
            <p>총 선택한 강좌 가격: <span id="total-price">₩0</span></p>
            <form id="orderForm" action="/order/regist" method="POST">
                <input type="hidden" name="idxList" id="selectedCourses">
                <input type="hidden" name="priceList" id="coursePrices">
                <button type="submit" id="checkoutBtn">결제하기</button>
            </form>
        </div>
        <!-- 강좌 리스트 -->
        <div class="cart-list" th:if="${cartList != null and cartList.size() > 0}">
            <div class="cart-item" th:each="item : ${cartList}" th:data-course-id="${item.idx}" style="border:1px solid #1e1e1e; margin: 2px">
                <div class="item-info">
                    <input type="checkbox" class="course-select">
                    <img th:src="${item.thumbnail}" alt="강좌 썸네일" class="thumbnail">
                    <div class="course-details">
                        <p class="course-title" th:text="${item.title}"></p>
                        <p class="course-teacher" th:text="${item.teacherId}"></p>
                        <p class="course-price" th:text="${item.price}"></p>
                        <p class="course-regDate" th:text="${#temporals.format(item.regDate, 'yyyy-MM-dd')}"></p>
                    </div>
                </div>
                <button class="delete-btn" th:data-course-id="${item.idx}" onclick="deleteBtns()">부분삭제</button>
            </div>
        </div>

        <div th:unless="${cartList != null and cartList.size() > 0}">
            <p>현재 장바구니에 담긴 강좌가 없습니다.</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('select-all');
        const courseCountSpan = document.getElementById('course-count');
        const totalPriceSpan = document.getElementById('total-price');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        let courseSelectCheckboxes = document.querySelectorAll('.course-select');
        const cartList = document.querySelector('.cart-list');

        let totalPrice = 0;

        // 전체 선택 체크박스 클릭 처리
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = selectAllCheckbox.checked;
            courseSelectCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateCourseCount();
            updateTotalPrice();
        });

        // 개별 강좌의 체크박스 클릭 처리
        function updateCourseCheckboxes() {
            courseSelectCheckboxes = document.querySelectorAll('.course-select');
            courseSelectCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateCourseCount();
                    updateTotalPrice();
                });
            });
        }
        //결제버튼
        document.getElementById('checkoutBtn').addEventListener('click', function (event) {
            e.preventDefault(); // 기본 폼 제출 방지

            const selectedCourses = [];
            const selectedPrices = [];
            const checkboxes = document.querySelectorAll('.course-select:checked'); // 선택된 강좌 체크박스

            checkboxes.forEach((checkbox) => {
                const cartItem = checkbox.closest('.cart-item'); // 부모 노드 탐색
                const courseId = cartItem.dataset.courseId; // idx
                const coursePrice = cartItem.querySelector('.course-price').innerText.replace(/₩|,/g, '').trim(); // price

                selectedCourses.push(courseId);
                selectedPrices.push(coursePrice);
            });

            // 선택된 값 폼에 반영
            document.getElementById('selectedCourses').value = selectedCourses.join(','); // idx 리스트
            document.getElementById('coursePrices').value = selectedPrices.join(','); // price 리스트

            // 폼 제출
            document.getElementById('orderForm').submit();
        });


        // 선택된 강좌들 삭제
        function deleteSelectedCourses() {
            const selectedItems = Array.from(document.querySelectorAll('.course-select:checked'));
            const idxList = selectedItems.map(item => item.closest('.cart-item').getAttribute('data-course-id'));
            console.log('선택된 강좌 ID들:', idxList);
            fetch('/cart/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ idxList: idxList })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('선택된 항목들이 삭제되었습니다!');
                        selectedItems.forEach(item => {
                            item.closest('.cart-item').remove();
                        });
                        updateCourseCheckboxes(); // 삭제 후 강좌 체크박스 업데이트
                        updateCourseCount();
                        updateTotalPrice();
                    } else {
                        alert('삭제 실패!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('오류가 발생했습니다.');
                });
        }

        // 삭제 버튼 클릭 시 처리
        deleteSelectedBtn.addEventListener('click', deleteSelectedCourses);

        // 각 개별 삭제 버튼 클릭 시 처리
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const courseId = button.getAttribute('data-course-id');
                fetch('/cart/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ idxList: [courseId] })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('삭제 성공!');
                            button.closest('.cart-item').remove();
                            updateCourseCheckboxes(); // 삭제 후 강좌 체크박스 업데이트
                            updateCourseCount();
                            updateTotalPrice();
                        } else {
                            alert('삭제 실패!');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('오류가 발생했습니다.');
                    });
            });
        });

        // 선택된 강좌들의 가격을 합산
        function updateTotalPrice() {
            totalPrice = 0;
            document.querySelectorAll('.cart-item').forEach(item => {
                const checkbox = item.querySelector('.course-select');
                const price = parseInt(item.querySelector('.course-price').innerText.replace('₩', '').replace(',', ''), 10);
                if (checkbox.checked) {
                    totalPrice += price;
                }
            });
            totalPriceSpan.innerText = `₩${totalPrice.toLocaleString()}`;
        }

        // 체크된 강좌 수 업데이트
        function updateCourseCount() {
            const selectedCount = Array.from(courseSelectCheckboxes).filter(checkbox => checkbox.checked).length;
            const totalCount = courseSelectCheckboxes.length;
            courseCountSpan.innerText = `(${selectedCount}/${totalCount})`;
        }


        // 페이지 로딩 후 강좌 체크박스 이벤트 다시 연결
        updateCourseCheckboxes();
    });
</script>